---
title: "Analyses"
author: "Chase Latour"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(survival)
library(Epi)
```

# Description

This HTML/Rmd document will contain the analyses for the data generated for the multiple_outcomes_pregnancy R project.

# Describe Cohort

Describe the patient cohort. This will allow us to check for weird data issues.

## Read in the data

```{r}

# Get the directory where the Rmd file is located
rmd_directory <- dirname(rstudioapi::getSourceEditorContext()$path)

# Specify the Excel file name and path relative to the Rmd file location
data_read <- file.path(rmd_directory, "data.rds")

dataset <- readRDS(data, file = data_read)

```

## Identify the cohort that entered the trial.

```{r}


trial <- dataset %>% 
  subset(trial_participant == TRUE) %>% 
  # Identify the observed outcomes
  mutate(preg_outcome_final = ifelse(trt == 1,
                                     preg_outcome_final_trt,
                                     preg_outcome_final_untrt),
         preg_outcome_final_gw = ifelse(trt == 1,
                                        preg_outcome_final_gw_trt,
                                        preg_outcome_final_gw_untrt),
         preeclampsia = ifelse(trt == 1,
                               preeclampsia_trt,
                               preeclampsia_untrt),
         sga = ifelse(trt == 1,
                      sga_trt,
                      sga_untrt))

```

## Number of trial participants

### Total

```{r}

trial %>% 
  summarize(count = n())

```

### Across treatment groups

```{r}

# Approx half and half, as expected
trial %>% 
  group_by(trt) %>% 
  summarize(count = n(),
            percent = round(count / nrow(trial) * 100),2)

```

### Timing of indexing into the cohort

Indexing was not intentionally differential by treatment group. If differences occur, it is likely due to patterns of pregnancy loss. This may not be particularly dramatic in the setting where everyone has a 50/50 chance of indexing every gestational week from weeks 4 through 20 (from conception).

Quantitative description of the distribution of gestational age at trial indices, by treatment group.

```{r}

trial %>% 
  group_by(trt) %>% 
  summarize(
            min = min(first_index),
            p25 = quantile(first_index, 0.25),
            median = median(first_index),
            p75 = quantile (first_index, 0.75),
            max = max(first_index)
            )

```

Figural description of the distribution of pregnancy outcomes, facet wrapped by treatment group.

```{r}

trial %>% 
  mutate(trt_label = factor(trt, labels = c("Treatment = 0", "Treatment = 1"))) %>% 
  ggplot(aes(x = first_index)) +
  geom_histogram(alpha=0.35, position = 'identity', binwidth = 1) +
  facet_wrap(~trt_label, scales = "free") +
  ylim(0, 200) +  # Set the y-axis limit to 0 to 200
  xlim(4, 20) +
  xlab("Gestational Week at Index") +  # Set the x-axis label
  ylab("Count")

```

## Number of live births and fetal deaths across treatment groups

```{r}

trial %>% 
  group_by(trt) %>% 
  summarize(fetal_death = sum(preg_outcome_final == 'fetaldeath'),
            fd_percent = round(fetal_death / n() * 100,1),
            livebirth = sum(preg_outcome_final == 'livebirth'),
            lb_percent = round(livebirth / n() * 100,1))

```

## Distribution of pregnancy outcomes

Quantitative description of the distribution of pregnancy outcomes, by treatment group.

```{r}

trial %>% 
  group_by(trt, preg_outcome_final) %>% 
  summarize(
            min = min(preg_outcome_final_gw),
            p25 = quantile(preg_outcome_final_gw, 0.25),
            median = median(preg_outcome_final_gw),
            p75 = quantile (preg_outcome_final_gw, 0.75),
            max = max(preg_outcome_final_gw),
            .groups = 'keep'
            )

```

Figural description of the distribution of pregnancy outcomes, facet wrapped by treatment group.

```{r}

trial %>% 
  mutate(trt_label = factor(trt, labels = c("Treatment = 0", "Treatment = 1"))) %>% 
  ggplot(aes(x = preg_outcome_final_gw, color = preg_outcome_final, fill = preg_outcome_final)) +
  geom_histogram(alpha=0.35, position = 'identity', binwidth = 1) +
  facet_grid(facets = trt_label ~.) +
  xlab("Gestational Week at Pregnancy Outcome") +
  ylab("Count") +
  labs(fill = "Pregnancy Outcome") 

```

## Number with preeclampsia and SGA

By treatment group.

```{r}

trial %>% 
  group_by(trt) %>% 
  summarize(preeclampsia = sum(preeclampsia == 1),
            preec_perc = round(preeclampsia / n() * 100, 1),
            sga = sum(sga == 1),
            sga_perc = round(sga / n() * 100, 1))

```

# Conduct Analyses

## KM Estimator Functions

Write out a function that will use the Kaplan-Meier estimator to estimate risk.

```{r}

km_estimator <- function(dataset, outcome_var){
  
  ## Run the KM analysis only considering the composite outcome.
  km <- survfit(Surv(preg_outcome_final_gw, get(outcome_var)) ~ trt, data = dataset)
  #summary(km)
  
  wrisk <- data.frame(t = km$time, s = km$surv, r = 1 - km$surv, se = km$std.err,
                          trt = c(rep(0, km$strata["trt=0"]), rep(1, km$strata["trt=1"])))
  
  return(wrisk)
  
}

```

Write out a function that will plot the KM curve.

```{r}

km_plot <- function(dataset, plot_title){
  riskplot <- ggplot() +
    geom_step(data = dataset, aes(x = t, y = r,  group = factor(trt), color = factor(trt)))+
    xlab("Weeks")+
    ylab("Risk") +
    scale_color_discrete(labels = c("Treated", "Untreated"))+
    ggtitle(plot_title) +  # Add the title parameter
   # scale_y_continuous(limits = c(0, 0.55), breaks = c(0, 0.1, 0.2, 0.3, 0.4, 0.5))+
    #scale_x_continuous(limits = c(0, 12), breaks = c(0, 2, 4, 6, 8,10, 12))+
    theme_classic(base_size = 15)+
    theme(legend.position = c(0.28, 0.9), legend.title = element_blank(),
          legend.background = element_rect(fill="transparent"), 
          panel.background = element_rect(fill = NA), 
          panel.grid.major = element_line(colour = "gray", linetype = "dotted")) 
  
  return(riskplot)
}


```

Write out a function to get the Risk Ratio at different points in follow-up

```{r, collapse=TRUE}


# Function to get the risk ratio with the corresponding confidence interval
km_rr_wCI <- function(data, t_val){
  
  estimate <- data %>% 
    filter(t == t_val) %>% 
    select(r,se,trt) %>% 
    pivot_wider(names_from = trt,
                values_from = c(r, se),
                names_glue = "{.value}_{trt}") %>% 
    rowwise() %>% 
    mutate(rr = r_1 / r_0,
           selnrr = sqrt((1/r_0)^2 * se_0^2 + (1/r_1)^2*se_1^2),
           lcl = exp(log(rr) - 1.96*selnrr),
           ucl = exp(log(rr) + 1.96*selnrr)) %>% 
    select(r_0, r_1, rr, lcl, ucl)
  
  return(estimate)
  
}

```

## AJ Estimator Functions

## Composite Preeclampsia and Fetal Death

### KM Estimator

Output the cumulative incidence curves at the end of follow-up.

```{r}

## Create the composite outcome
set.seed(1234) # Set seed so that censoring is the same
trial2 <- trial %>% 
  mutate(composite = ifelse(preg_outcome_final == "fetaldeath" | preeclampsia == 1,
                            1,
                            0))

## Run the KM analysis only considering the composite outcome.
wrisk <- km_estimator(trial2, "composite")


# km <- survfit(Surv(preg_outcome_final_gw, composite) ~ trt, data = trial2)
# #summary(km)
# 
# wrisk <- data.frame(t = km$time, s = km$surv, r = 1 - km$surv, se = km$std.err,
#                         trt = c(rep(0, km$strata["trt=0"]), rep(1, km$strata["trt=1"])))

riskplot <- km_plot(wrisk, "KM Estimator of Risk for Composite Outcome")

riskplot

#ggsave(riskplot, file = "q13.png", width = 5, heigh = 5, units = "cm")

```

Output the risk ratio at the end of follow-up.

```{r}

#############################################################################################
## Calculate the RR at different weeks of follow-up; SE is infinity at 42 weeks of follow-up
## -- ASK JESS about this.
## -- Funky thing: The standard errors get substantially larger as the weeks progress.
## -- Likely because there are fewer and fewer individuals at risk at 42 weeks.
## -- Need to check this intuition with Jess.

# Get it at 39 weeks
km_rr_wCI(wrisk, 39)

# 40 weeks
km_rr_wCI(wrisk, 40)

# 41 weeks
km_rr_wCI(wrisk, 41)

# 42 weeks
km_rr_wCI(wrisk, 42)


## Hand calculate at 42 weeks
## This is a closed cohort without LTFU, this should be correct
## -- regardless of AJ estimator.
## -- Would be interesting to look at the differences in their risk estimates.
trial2 %>% 
  group_by(trt) %>% 
  summarize(count = sum(composite == 1),
            percent = round(count / n() * 100,2),
            .groups = 'drop') 
log(0.3659/0.4766) - log(0.4268/0.5995)



```

### AJ Estimator

```{r, eval=FALSE}

## Run the competing events analysis
## -- We haven't introduced censoring right now, so there are only two possible outcomes:
## -- fetal death or live birth.

#jitter ties
set.seed(1234) # Set seed so that censoring is the same
trial2 <- trial %>% 
  group_by(preg_outcome_final_gw) %>% 
  add_tally() %>% 
  ungroup() %>% 
  mutate(
    # Create censoring
    censor = rbinom(nrow(trial2), size=1, 0.05),
    # Jitter event times
    jitter = runif(nrow(trial2), min = -.01, max = .01), # N in the samp
    preg_outcome_final_gw = ifelse(n>1, preg_outcome_final_gw + jitter, preg_outcome_final_gw),
    # Make a multi-level outcome - should be adaptable to censoring in the future (i.e., 0, 1, or 2)
    composite_multi = case_when(censor == 0 & preg_outcome_final == "fetaldeath" ~ 1,
                                censor == 0 & preeclampsia == 1 ~ 1,
                                censor == 0 & preg_outcome_final == "livebirth" & preeclampsia == 0 ~ 2,
                                censor == 1 ~ 0)
    )

# Run the AJ model
aj <- survfit(Surv(preg_outcome_final_gw, factor(composite_multi)) ~ trt, data = trial2)

mod <- summary(aj)

summod <- data.frame(t = mod$time,
                     r = mod$pstate[,2], 
                     se = mod$std.err[,2],
                     # This is not right yet
                     #trt = c(rep(0, mod$strata["trt=0"]), rep(1, mod$strata["trt=1"]))
                     trt = c(rep(0, length(mod[["strata"]][mod[["strata"]] == "trt=0"])), 
                                 rep(1, length(mod[["strata"]][mod[["strata"]] == "trt=1"])))
                     ) %>%
  group_by(trt) %>% 
  summarize(r = last(r),
            se = last(se),
            .groups = 'drop') %>% 
  select(r,se,trt) %>% 
    pivot_wider(names_from = trt,
                values_from = c(r, se),
                names_glue = "{.value}_{trt}") %>% 
    rowwise() %>% 
    mutate(rr = r_1 / r_0 #,
           #selnrr = sqrt((1/r_0)^2 * se_0^2 + (1/r_1)^2*se_1^2),
           #lcl = exp(log(rr) - 1.96*selnrr),
           #ucl = exp(log(rr) + 1.96*selnrr)
           ) %>% 
    select(r_0, r_1, rr
           #, lcl, ucl
           )
            



  pivot_wider(names_from=trt, values_from = c(r, se)) %>%
  mutate(rr = r_1/r_0,
         rd = r_1 - r_0,
         # use delta method to get 95% CI
         logRR = log(rr),
         var_1 = se_1^2,
         var_0 = se_0^2,
         var_logRR = (1/r_0)^2 * var_0 + (1/r_1)^2 * var_1,
         logRR_lower = logRR - 1.96*sqrt(var_logRR),
         logRR_upper = logRR + 1.96*sqrt(var_logRR),
         RR_lower = exp(logRR_lower),
         RR_upper = exp(logRR_upper),
         se_rd = sqrt(se_1^2 + se_0^2),
         RD_lower = rd - 1.96*se_rd,
         RD_upper = rd + 1.96*se_rd) %>%
  select(rr, RR_lower, RR_upper, rd, RD_lower, RD_upper)




mod <- summary(survfit(Surv(t, factor(delta)) ~ bshiv, data = dat_bmacs2), times = 3000)
 
summod <- data.frame(r = mod$pstate[,2], se = mod$std.err[,2], hiv = c(0,1)) %>%
  pivot_wider(names_from=hiv, values_from = c(r, se)) %>%
  mutate(rr = r_1/r_0,
         rd = r_1 - r_0,
         # use delta method to get 95% CI
         logRR = log(rr),
         var_1 = se_1^2,
         var_0 = se_0^2,
         var_logRR = (1/r_0)^2 * var_0 + (1/r_1)^2 * var_1,
         logRR_lower = logRR - 1.96*sqrt(var_logRR),
         logRR_upper = logRR + 1.96*sqrt(var_logRR),
         RR_lower = exp(logRR_lower),
         RR_upper = exp(logRR_upper),
         se_rd = sqrt(se_1^2 + se_0^2),
         RD_lower = rd - 1.96*se_rd,
         RD_upper = rd + 1.96*se_rd) %>%
  select(rr, RR_lower, RR_upper, rd, RD_lower, RD_upper)



## Plotting AJ estimators:
#https://search.r-project.org/CRAN/refmans/Epi/html/plotCIF.html

## More AJ R code:
#https://cran.r-project.org/web/packages/AalenJohansen/index.html






# Jess's original code


#' a function to estimate risk of preg loss by end of follow-up
#' 
est_risk <- function(data){
  mod <- survfit(Surv(t_pend, factor(j_birth)) ~ 1, data = data)
  smod <- summary(mod)
  resdat <- data.frame(time = smod$time, risk = smod$pstate[,2], risklb  = smod$pstate[,3])
  return(resdat %>% slice(n()) %>% pull(risk))
}


wraprisk <- function(i){
  dat0 <- gen(i, 2000, 0.5, 0.2, cenrate = 0)
  risk0 <- est_risk(dat0)
 
  dat20 <- gen(i, 2000, 0.5, 0.2, cenrate = .20)
  risk20 <- est_risk(dat20)
 
  dat80 <- gen(i, 2000, 0.5, 0.2, cenrate = .80)
  risk80 <- est_risk(dat80)
 
  return(c(risk0, risk20, risk80))
}

J <- 1000
risks <- matrix(nrow = J, ncol = 3)
for(i in 1:J){
  if(i %% 100 == 0) print(i)
  risks[i,] <- wraprisk(i)
}


res <- colMeans(risks)
names(res) <- c("No censoring", "20% censoring", "80% censoring")
res

# results reproduced here
# No censoring 20% censoring 80% censoring 
# 0.1000840     0.1001554     0.0999860 

# sample plot 
dat0 <- gen(i, 10000, 0.5, 0.2, cenrate = 0)
data <- dat0
preg_mod <- survfit(Surv(t, j) ~ 1, data = data)
smod_preg <- summary(preg_mod)
resdat_preg <- data.frame(time = smod_preg$time, risk = 1 - smod_preg$surv) %>% 
  add_row(time = 4.75, risk = 1 - tail(smod_preg$surv, n=1))

mod <- survfit(Surv(t_pend, factor(j_birth)) ~ 1, data = data)
smod <- summary(mod)
resdat <- data.frame(time = smod$time, risk_loss = smod$pstate[,2], 
                     risk_lb = smod$pstate[,3])
resdat_all <- merge(resdat, resdat_preg, by = "time", all = T) %>%
  fill(risk, risk_loss, risk_lb, .direction = "down") 

plot <- ggplot() +
  geom_step(aes(x = time, y = risk), data = resdat_preg, color = "steelblue") +
  geom_step(aes(x = time, y = risk_loss + risk_lb), data = resdat, color = "darkred") +
  geom_step(aes(x = time, y = risk_lb ), data = resdat) +
  geom_ribbon(aes(x = time, ymin = 0, ymax = risk_lb), data = resdat, fill = "grey", 
              alpha = 0.2) +
  geom_ribbon(aes(x = time, ymin = risk_lb, ymax = risk_loss + risk_lb), data = resdat, 
              fill = "darkred", 
              alpha = 0.2) +
  geom_ribbon(aes(x = time, ymin = risk_loss + risk_lb, ymax = risk), data = resdat_all, 
              fill = "steelblue", 
              alpha = 0.2) +
  annotate("text",x = 1, y = 0.45, label = "Not pregnant yet")+
  annotate("text",x = 3.5, y = 0.05, label = "Had live birth")+
  annotate("text",x = 4, y = 0.33, label = "Loss", angle = 55)+
  annotate("text",x = 2.5, y = 0.2, label = "Pregnant", angle = 55)+
  xlim(0, 5)

ggsave(plot, file = "/Users/jkedwar/BoxSync/Research/HIVmeths/side/pregplot.png", width =10, height = 10,  units = "cm")


```

## SGA

### KM Estimator

Output the cumulative incidence curves at the end of follow-up.

```{r}

## Create the composite outcome
# trial2 <- trial %>% 
#   mutate(composite = ifelse(preg_outcome_final == "fetaldeath" || preeclampsia == 1,
#                             1,
#                             0))

## Run the KM analysis only considering the composite outcome.
wrisk <- km_estimator(trial, "sga")


# km <- survfit(Surv(preg_outcome_final_gw, composite) ~ trt, data = trial2)
# #summary(km)
# 
# wrisk <- data.frame(t = km$time, s = km$surv, r = 1 - km$surv, se = km$std.err,
#                         trt = c(rep(0, km$strata["trt=0"]), rep(1, km$strata["trt=1"])))

riskplot <- km_plot(wrisk, "KM Estimator of Risk for SGA")

riskplot

#ggsave(riskplot, file = "q13.png", width = 5, heigh = 5, units = "cm")

```

Output the risk ratio at the end of follow-up.

```{r}

#############################################################################################
## Calculate the RR at different weeks of follow-up; SE is infinity at 42 weeks of follow-up
## -- ASK JESS about this.
## -- Funky thing: The standard errors get substantially larger as the weeks progress.
## -- Likely because there are fewer and fewer individuals at risk at 42 weeks.
## -- Need to check this intuition with Jess.

# Get it at 39 weeks
km_rr_wCI(wrisk, 39)

# 40 weeks
km_rr_wCI(wrisk, 40)

# 41 weeks
km_rr_wCI(wrisk, 41)

# 42 weeks
km_rr_wCI(wrisk, 42)

## Hand calculate at 42 weeks
## This is a closed cohort without LTFU, this should be correct
## -- regardless of AJ estimator.
## -- Would be interesting to look at the differences in their risk estimates.
trial %>% 
  group_by(trt) %>% 
  summarize(count = sum(sga == 1),
            percent = round(count / n() * 100,2),
            .groups = 'drop') 
log(0.1117/0.1170) - log(0.2986/0.3566)


```


### AJ Estimator

## Preterm live birth

Output the cumulative incidence curves at the end of follow-up.

```{r}

## Create the composite outcome
trial2 <- trial %>% 
  mutate(preterm = ifelse(preg_outcome_final == "livebirth" & preg_outcome_final_gw < 37,
                          1,
                          0))

## Run the KM analysis only considering the composite outcome.
wrisk <- km_estimator(trial2, "preterm")


# km <- survfit(Surv(preg_outcome_final_gw, composite) ~ trt, data = trial2)
# #summary(km)
# 
# wrisk <- data.frame(t = km$time, s = km$surv, r = 1 - km$surv, se = km$std.err,
#                         trt = c(rep(0, km$strata["trt=0"]), rep(1, km$strata["trt=1"])))

riskplot <- km_plot(wrisk, "KM Estimator of Risk for Preterm Live Birth")

riskplot

#ggsave(riskplot, file = "q13.png", width = 5, heigh = 5, units = "cm")

```

Output the risk ratio at the end of follow-up.

```{r}

#############################################################################################
## Calculate the RR at different weeks of follow-up; SE is infinity at 42 weeks of follow-up
## -- ASK JESS about this.
## -- Funky thing: The standard errors get substantially larger as the weeks progress.
## -- Likely because there are fewer and fewer individuals at risk at 42 weeks.
## -- Need to check this intuition with Jess.

# Get it at 37 weeks
km_rr_wCI(wrisk, 37)

# Get it at 39 weeks
km_rr_wCI(wrisk, 39)

# 40 weeks
km_rr_wCI(wrisk, 40)

# 41 weeks
km_rr_wCI(wrisk, 41)

# 42 weeks
km_rr_wCI(wrisk, 42)

```

