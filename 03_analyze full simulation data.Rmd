---
title: "Analyze Data from Monte Carlo Simulation"
author: "Chase Latour"
date: "`r Sys.Date()`"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(knitr)
library(kableExtra)
```

# Pull in the Data

```{r}

# CHANGE THE 2 TO 12


# Descriptive data from each of the scenarios

for (x in 1:2) {
  # Construct the file name
  file_name <- paste0("describe trial_scenario", x, ".rds")
  
  # Read the RDS file
  dataset <- readRDS(file_name)
  
  # Add the new variable 'scenario'
  dataset$scenario <- x
  
  # Construct the variable name
  var_name <- paste0("describe_scenario", x)
  
  # Assign the dataset to the dynamically named variable
  assign(var_name, dataset)
  
}

combined_describe_trial <- bind_rows(describe_scenario1, describe_scenario2)



# Analysis data for each of the scenarios

for (x in 1:2) {
  # Construct the file name
  file_name <- paste0("analyses_scenario", x, ".rds")
  
  # Read the RDS file
  dataset <- readRDS(file_name)
  
  # Add the new variable 'scenario'
  dataset$scenario <- x
  
  # Construct the variable name
  var_name <- paste0("analyses_scenario", x)
  
  # Assign the dataset to the dynamically named variable
  assign(var_name, dataset)
}

combined_analyses <- bind_rows(analyses_scenario1, analyses_scenario2)

```

# Descriptives of Trial Population

```{r}

n_outcomes <- combined_describe_trial %>% 
  group_by(scenario, trt) %>% 
  summarize(n_pregnancies = median(n_people),
            n_censored = median(n_censor),
            n_fetal_deaths = median(n_fd_no_censor),
            n_live_births = median(n_lb_no_censor),
            .groups = 'drop')

totals_by_scenario <- n_outcomes %>% 
  group_by(scenario) %>% 
  summarize(total_pregnancies = sum(n_pregnancies),
            total_censored = sum(n_censored),
            total_fetal_deaths = sum(n_fetal_deaths),
            total_live_births = sum(n_live_births),
            .groups = 'drop')

descriptives <- left_join(n_outcomes, totals_by_scenario, by = ("scenario" = "scenario"))

descriptives2 <- descriptives %>% 
  rowwise() %>% 
  mutate(perc_pregnancies = round(100*n_pregnancies / total_pregnancies, 2),
         perc_censored = round(100*n_censored / total_censored, 2),
         perc_fetal_deaths = round(100*n_fetal_deaths / total_fetal_deaths, 2),
         perc_live_births = round(100*n_live_births / total_live_births, 2)) %>% 
  ungroup() %>% 
  mutate(pregnancies = paste0(n_pregnancies, " (", perc_pregnancies, "%)"),
         censored = paste0(n_censored, " (", perc_censored, "%)"),
         fetal_deaths = paste0(n_fetal_deaths, " (", perc_fetal_deaths, "%)"),
         live_births = paste0(n_live_births, " (", perc_live_births, "%)")) %>% 
  select(scenario, trt, pregnancies, censored, fetal_deaths, live_births) %>% 
  pivot_wider(id_cols = scenario, 
              names_from = trt,
              values_from = c(pregnancies, censored, fetal_deaths, live_births))
  
descriptives2 %>% 
  knitr::kable(digits = 3, format.args = list(big.mark = ",", scientific = FALSE),
               col.names = c()) %>% # Trying to add commas to larger numbers
  kable_classic() %>% 
  add_header_above(c("Scenario" = 1, "Untreated" = 1, "Treated" = 1, 
                     "Untreated" = 1, "Treated" = 1,
                     "Untreated" = 1, "Treated" = 1, 
                     "Untreated" = 1, "Treated" = 1)) %>% 
  add_header_above(c(" " = 1, "Number of Pregnancies" = 2, 
                     "Number of Censored Pregnancies" = 2,
                     "Number of Fetal Deaths" = 2, 
                     "Number of Live Births" = 2)) 

```

# Results

CALCULATE THE NUMBER WITH UNDEFINED CIS


```{r}

# Establish the true estimates as the average of the potential outcomes

truth <- combined_analyses %>% 
  group_by(scenario) %>% 
  summarize(composite_truth_rd = mean(`potential_ rd_composite`),
            composite_truth_rr = exp(mean(log(`potential_ rr_composite`))),
            sga_truth_rd = mean(`potential_ rd_sga`),
            sga_truth_rr = exp(mean(log(`potential_ rr_sga`))))

# # Calculate averages for ESE, MSE,etc.
# average <- combined_analyses %>% 
#   group_by(scenario) %>% 
#   summarize(km_composite_r0_average = mean(`km_composite_ r_0`),
#             km_composite_r1_average = mean(`km_composite_ r_1`),
#             km_composite_rd_average = mean(`km_composite_ rd`),
#             km_composite_rr_average = exp(mean(log(`km_composite_ rr`))),
#             aj_composite_r0_average = mean(`composite_multi_gw r_0`),
#             aj_composite_r1_average = mean(`composite_multi_gw r_1`),
#             aj_composite_rd_average = mean(`composite_multi_gw rd`),
#             aj_composite_rr_average = exp(mean(log(`composite_multi_gw rr`))),
#             km_sga_r0_average = mean(`km_sga_all_ r_0`),
#             km_sga_r1_average = mean(`km_sga_all_ r_1`),
#             km_sga_rd_average = mean(`km_sga_all_ rd`),
#             km_sga_rr_average = exp(mean(log(`km_sga_all_ rr`))),
#             aj_sga_all_r0_average = mean(`km_sga_all_ r_0`),
#             aj_sga_all_r1_average = mean(`km_sga_all_ r_1`),
#             aj_sga_all_rd_average = mean(`aj_sga_all_ rd`),
#             aj_sga_all_rr_average = exp(mean(log(`aj_sga_all_ rr`))),
#             aj_sga_fd_r0_average = mean(`aj_sga_fd_ r_0`),
#             aj_sga_fd_r0_average = mean(`aj_sga_fd_ r_1`),
#             aj_sga_fd_rd_average = mean(`aj_sga_fd_ rd`),
#             aj_sga_fd_rr_average = mean(`aj_sga_fd_ rr`))

  
# Add the derived values to the dataset
combined_analyses2 <- left_join(combined_analyses, truth, by = "scenario") #%>% 
  # left_join(average, by = "scenario")


calculate_simulation_values <- function(dataset){
  
  hold <- dataset %>% 
    group_by(scenario) %>% 
    summarize(km_r0 = mean(kmr0),
              km_r0_se = sqrt((1 / (n()*(n()-1)))*
                                sum((kmr0 - km_r0)^2)),
              km_r1 = mean(kmr1),
              km_r1_se = sqrt((1 / (n()*(n()-1)))*
                                sum((kmr1 - km_r1)^2)),
              km_rd = mean(kmrd),
              km_rd_se = sqrt((1 / (n()*(n()-1)))*
                                sum((kmrd - km_rd)^2)),
              km_rd_bias = mean(kmrd - rd_truth),
              km_rd_ese = sqrt((1/(n()-1))*
                                 sum((kmrd - km_rd)^2)),
              # km_rd_ese_se = km_rd_ese / sqrt(2 * (n() - 1)),
              km_rd_rmse = sqrt((1/n())*
                                  sum((kmrd - rd_truth)^2)),
              km_rr = mean(kmrr),
              km_lnrr_se = sqrt((1 / (n()*(n()-1)))*
                                  sum((log(kmrr) -
                                         log(km_rr))^2)),
              km_lnrr_bias = mean(log(kmrr) -
                                  log(rr_truth)),
              km_lnrr_ese = sqrt((1/(n()-1))*
                                 sum((log(kmrr) - log(km_rr))^2)),
              # km_lnrr_ese_se = km_rr_ese / sqrt(2 * (n() - 1)),
              km_lnrr_rmse = sqrt((1/n())*
                                  sum((log(kmrr) - log(rr_truth))^2)),
              aj_r0 = mean(ajr0),
              aj_r0_se = sqrt((1 / (n()*(n()-1)))*
                                sum((ajr0 -
                                       aj_r0)^2)),
              aj_r1 = mean(ajr1),
              aj_r1_se = sqrt((1 / (n()*(n()-1)))*
                                sum((ajr1 -
                                       aj_r1)^2)),
              aj_rd = mean(ajrd),
              aj_rd_se = sqrt((1 / (n()*(n()-1)))*
                                sum((ajrd - 
                                       aj_rd)^2)),
              aj_rd_bias = mean(ajrd - rd_truth),
              aj_rd_ese = sqrt((1/(n()-1))*
                                 sum((ajrd - aj_rd)^2)),
              aj_rd_rmse = sqrt((1/n())*
                                  sum((ajrd - rd_truth)^2)),
              aj_rr = exp(mean(log(ajrr))),
              aj_lnrr_se = sqrt((1 / (n()*(n()-1)))*
                                  sum((log(ajrr) - 
                                         log(aj_rr))^2)),
              aj_lnrr_bias = mean(log(ajrr) -
                                  log(rr_truth)),
              aj_lnrr_ese = sqrt((1/(n()-1))*
                                 sum((log(ajrr) - log(aj_rr))^2)),
              aj_lnrr_rmse = sqrt((1/n())*
                                  sum((log(ajrr) - log(rr_truth))^2))
              )
  
  return(hold)
  
}
  

# Get the estimates for the composite outcome

composite_outcome <- combined_analyses2 %>% 
  rename(kmr0 = `km_composite_ r_0`,
         kmr1 = `km_composite_ r_1`,
         kmrd = `km_composite_ rd`,
         kmrr = `km_composite_ rr`,
         ajr0 = `composite_multi_gw r_0`,
         ajr1 = `composite_multi_gw r_1`,
         ajrd = `composite_multi_gw rd`,
         ajrr = `composite_multi_gw rr`,
         rd_truth = composite_truth_rd,
         rr_truth = composite_truth_rr) %>% 
  calculate_simulation_values() %>% 
  mutate(Outcome = "Composite")
  
# SGA - FD only
sga_fd_only <- combined_analyses2 %>% 
  rename(kmr0 = `km_sga_fd_ r_0`,
         kmr1 = `km_sga_fd_ r_1`,
         kmrd = `km_sga_fd_ rd`,
         kmrr = `km_sga_fd_ rr`,
         ajr0 = `aj_sga_fd_ r_0`,
         ajr1 = `aj_sga_fd_ r_1`,
         ajrd = `aj_sga_fd_ rd`,
         ajrr = `aj_sga_fd_ rr`,
         rd_truth = sga_truth_rd,
         rr_truth = sga_truth_rr) %>% 
  calculate_simulation_values() %>% 
  mutate(Outcome  = "SGA - Fetal death only competing event")

# SGA - All competing events
sga_all <- combined_analyses2 %>% 
  rename(kmr0 = `km_sga_all_ r_0`,
         kmr1 = `km_sga_all_ r_1`,
         kmrd = `km_sga_all_ rd`,
         kmrr = `km_sga_all_ rr`,
         ajr0 = `aj_sga_all_ r_0`,
         ajr1 = `aj_sga_all_ r_1`,
         ajrd = `aj_sga_all_ rd`,
         ajrr = `aj_sga_all_ rr`,
         rd_truth = sga_truth_rd,
         rr_truth = sga_truth_rr) %>% 
  calculate_simulation_values() %>% 
  mutate(Outcome  = "SGA - All competing events")
  

## Then stack


```

